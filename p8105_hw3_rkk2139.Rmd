---
title: "p8105_hw3_rkk2139"
author: "Riya Kalra"
output: github_document
---

```{r chunk1}
library(p8105.datasets)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(tidyr)

# Load datasets
covar <- read_csv("https://p8105.com/data/nhanes_covar.csv", col_names = TRUE, skip = 4)
covar <- covar %>%
  mutate(
    sex = recode(sex, `1` = "Male", `2` = "Female"),
    education = recode(education, `1` = "Less than high school",
                                `2` = "High school equivalent",
                                `3` = "More than high school")
  )

accel_df <- read_csv("https://p8105.com/data/nhanes_accel.csv", skip = 1 )

# Import and clean accel.csv
accel_df =
  read_csv ("https://p8105.com/data/nhanes_accel.csv") |>
  janitor::clean_names () |> 
  pivot_longer (
    min1:min1440,
    names_to = "minute_interval",
    names_prefix = "min",
    values_to = "mims"
  ) |> # Pivot these columns
  mutate(minute_interval = as.numeric(minute_interval))

covar_df =
  read_csv ("https://p8105.com/data/nhanes_covar.csv", skip = 4) |> # skip first 4 rows
  janitor::clean_names() |>
  drop_na(sex, age, bmi, education) |> # drop N/A rows from demographic data
  filter(!(age < 21)) |> # filter out people younger than 21
  mutate (
    # encode variable with reasonable names
    sex = case_match (sex, 1 ~ "Male", 2 ~ "Female"),
    education = case_match(
      education,
      1 ~ "Less than high school",
      2 ~ "High school equivalent",
      3 ~ "More than high school"
    ),
    education = factor(
      # create factor variable
      education,
      levels = c(
        "Less than high school",
        "High school equivalent",
        "More than high school"
      )
    )
  )

merged_df <- accel_df |> 
  left_join(covar_df, by = "seqn")
```

```{r, cache = TRUE}
# Create summary table of the number of men and women in each education category
education_sex_table <- covar_df |> 
  group_by(sex, education) |> 
  summarize(count = n(), .groups = "drop") |> 
  pivot_wider(names_from = sex, values_from = count) |> 
  arrange(education)

# Print the table in a reader-friendly format
education_sex_table |> 
  knitr::kable(
    col.names = c("Education Level", "Female", "Male"),
    caption = "Number of Men and Women in Each Education Category"
)

#looks slightly off
age_distribution_histogram <- covar_df |> 
  ggplot(aes(x = age, fill = sex)) + 
  geom_histogram(binwidth = 5, position = "dodge", alpha = 0.7) + 
  facet_wrap(~education, nrow = 1) +  # Create separate panels for each education level
  labs(
    title = "Age Distribution by Sex and Education Category",
    x = "Age",
    y = "Count",
    fill = "Sex"
  ) + 
  theme_minimal() + 
  scale_fill_manual(values = c("Male" = "blue", "Female" = "pink"))

# Print the plot
print(age_distribution_histogram)
```

```{r, cache = TRUE}
# Aggregate accelerometer data by participant to get total daily activity
total_activity_df <- accel_df |> 
  group_by(seqn) |> 
  summarize(total_activity = sum(mims, na.rm = TRUE))  # Total activity for each participant

# Merge with the demographic data (covar_df)
merged_df <- total_activity_df |> 
  inner_join(covar_df, by = "seqn")  # Join on 'seqn' (participant ID)

#pivot wider
# Plot total activity against age, comparing men and women, and facet by education
ggplot(merged_df, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +  # Scatter plot with some transparency for readability
  geom_smooth(method = "loess", se = FALSE) +  # Add a smooth trend line
  facet_wrap(~education) +  # Separate panels for each education level
  labs(
    title = "Total Daily Activity vs. Age by Gender and Education Level",
    x = "Age",
    y = "Total Daily Activity (MIMS)",
    color = "Gender"
  ) +
  theme_minimal() +  # Clean theme for readability
  theme(legend.position = "top")  # Move the legend to the top

# Merge accelerometer data with demographic data (for sex and education)
merged_df <- accel_df |> 
  inner_join(covar_df, by = "seqn")  # Join on 'seqn' (participant ID)

# Plot 24-hour activity time course for each education level, with color by sex, and x-axis in minutes
ggplot(merged_df, aes(x = minute_interval, y = mims, color = sex, group = seqn)) +
  geom_line(alpha = 0.2) +  # Light lines for individual participants' activity
  geom_smooth(aes(group = sex), method = "loess", se = FALSE, size = 1.2) +  # Smooth trends for each sex
  facet_wrap(~education, nrow = 1) +  # Three panels side by side for each education level
  scale_x_continuous(
    breaks = seq(0, 1440, by = 240),  # Label major time points in minutes
    labels = seq(0, 1440, by = 240)  # Use minute intervals as labels
  ) +
  labs(
    title = "24-Hour Activity Time Course by Education Level and Gender",
    x = "Time of Day (Minutes)",
    y = "Activity (MIMS)",
    color = "Gender"
  ) +
  theme_minimal() +
  theme(legend.position = "top")  # Position the legend at the top
```


